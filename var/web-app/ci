# vim: ft=ruby et ts=4 sw=4

include ../../include/dust/lib.ux;
include ../../include/dust/lib.docker;
include ../../ci/lib;

def Delete_stale_environment = {
    docker container rm
        --force
        --volumes
        $_DOCKER_NAME
}

def Start_detach_container = {
    docker container run
        --detach
        --name $_DOCKER_NAME
        $_DOCKER_IMAGE
        sh -c "while true; do sleep 1; done"
}

def List_container = {
    src filter = p "name=" $_DOCKER_NAME;

    docker container ls
        --filter $filter
}

def exec = {
    ux::begin $args;
    src _ = !xs-call $_CI_LIB $args;
    !xs-write_in <$_ /dev/null;
    ux::ok $args;
}

def exec_show = {
    ux::progress $args;
    !echo;
    !xs-call $_CI_LIB $args;
    ux::ok $args;
}

def ci-up = {
    exec Delete_stale_environment $_DOCKER_NAME "";
    exec Start_detach_container $_DOCKER_NAME "";
    exec_show List_container $_DOCKER_NAME "";
}
