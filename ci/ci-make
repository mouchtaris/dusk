# vim: et ft=ruby ts=4 sw=4

def TARGET = "test.dust";
def TESTBIN = "_.test.dustbin";

def cargo = {
    !cargo
        --color always
        $args
}
def cargo_run = {
    cargo run
        --features serde_cbox
        $args
}

def build = {
    def check = cargo check --all-targets $args;
    def build = cargo build --all-targets $args;
    check $args;
    build $args
}

def xs-compile = {
    #./target/debug/xs-compile $TARGET $TESTBIN
    ./target/release/xs-compile $TARGET $TESTBIN
}

def xs-run = {
    #./target/debug/xs-run $TESTBIN THE LOLZ
    ./target/release/xs-run $TESTBIN THE LOLZ
}

def xs-debug = {
    #./target/debug/xs-debug $TESTBIN
    ./target/release/xs-debug $TESTBIN
}

def compile_run = {
    build 
        --release --features release
    ;
    xs-compile;
    xs-run;
    0
}

def main = {
    # compile_run;
    !xs2 web-app.dust MAKEFILE;
    0
}

def loop = {
    let git_files = !git ls-files;
    src files = !printf "%s\n" test.dust $git_files;
    !entr <$files xs-run bin/ci-make
}

main;
0
