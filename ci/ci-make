# vim: et ft=ruby ts=4 sw=4

def cargo = {
    !cargo
        --color always
        $args
}
def cargo_run = {
    cargo run
        --features serde_cbox
        $args
}

def build = {
    def check = cargo check --all-targets $args;
    def build = cargo build --all-targets $args;
    check $args;
    build $args
}

def build_std = {
    !mkdir -pv target/lib/dust;
    !xs-compile lib/stdlib.dust target/lib/dust/stdlib
}

def xs2-dev =
    ./target/debug/main $args
;

def main = {
    # build;
    # xs2-dev ci/ci-install-system;
    build_std;
    !xs2 "./web-app/ci.dust";
    0
}

def loop = {
    let git_files = !git ls-files;
    src files = !printf "%s\n" test.dust $git_files;
    !entr <$files xs-run bin/ci-make
}

main;
0
