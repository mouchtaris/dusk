# vim: et ft=ruby ts=4 sw=4

include ./config;

include ../include/dust/std;
include ../include/dust/lib.term/lib;
include ../include/dust/lib.ide/lib;

include ./lib.install;

def archive = !git archive HEAD --format tar;
include ./lib.docker;

def libci = ide::target_path ci/lib;

def ci::build = {
    ide::compile ci/lib;
    ide::dusk-build $libci var/web-app/config.local var/web-app;
}

def ci::build_aba = {
    ide::dusk-build $libci ci/config var/aba;
}

def ci::compile_all = {
    ci::build;

    src config = "./ci/config";
    ide::dusk-build $libci $config ./include/dust/hashi;

    !lsd
        --color always
        --tree
        --ignore-glob hashi
        include/
        $_.lib.ide/target_path
    ;
}

def ci::bootstrap-local = {
    uninstall::local;
    install::local-lib;
    install::local;
    ci::compile_all;
    install::make_bin_release_tar;
}

def ci::bootstrap-system = {
    uninstall::system;
    install::lib;
    install::system;
    ci::compile_all;
    install::make_bin_release_tar;
}

def ci::build_grammar = {
    ide::compile grammar/ci.dust;
}

def ci::test-spec = {
    !xs-run <(!xs-compile spec/spec);
}

def test = {
    ;
}
