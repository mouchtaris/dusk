# vim: et ft=scala ts=4 sw=4

def util/join = !printf "%s" $args;

def DOCKER_CONTEXT = !cat ./etc/ci_docker_context;
def VOLUME = "dust-ctx-0";
def BASE = "dust3:base";
def DIST = "dust3:dist";
def COPY = "d3c";
def MEM = "/home/bob";
def DOCKERFILE = "_.dockerfile";

def Dockerfile =
  r#" FROM debian as base
      RUN apt-get update -y && apt-get upgrade -y
      RUN apt-get install -y curl
      RUN apt-get install -y gcc
      RUN apt-get install -y sudo
      RUN apt-get install -y git

      RUN useradd -d /home/bob -m -G sudo bob
      RUN ln -svf /home/bob/bin /,
      RUN echo "%sudo  ALL=(ALL) NOPASSWD: ALL" | tee -a /etc/sudoers
      RUN curl -LO 'https://github.com/Peltoche/lsd/releases/download/0.21.0/lsd_0.21.0_amd64.deb'
      RUN dpkg -i lsd_0.21.0_amd64.deb
      USER bob
      WORKDIR /home/bob


      FROM base as base-build
      RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs --output rustup.sh
      RUN bash rustup.sh -y --verbose
      RUN $HOME/.cargo/bin/cargo install --bin dev_workspace --git https://gitlab.com/gvz/rs/ --branch main


      FROM base-build as deps
      RUN mkdir -pv release
      ADD --chown=bob:bob Cargo.yaml release
      RUN cd release && \
        $HOME/.cargo/bin/dev_workspace --for-real && \
        printf '%s\n' '[build-dependencies]' 'lalrpop = "0.19.6"' | tee -a m/parse/Cargo.toml && \
        $HOME/.cargo/bin/cargo check --release --all-targets && \
        $HOME/.cargo/bin/cargo build --release --all-targets && \
        true

      FROM deps as source
      ADD _.source.tar release/
      RUN sudo chown -Rv bob:bob release

      FROM source as build
      RUN cd release && $HOME/.cargo/bin/cargo build --release --bin xs-compile
      RUN cd release && $HOME/.cargo/bin/cargo build --release --bin xs-run
      RUN cd release && $HOME/.cargo/bin/cargo build --release --bin xs2


      FROM build as install
      RUN cd release && . $HOME/.cargo/env && target/release/main ci/ci-install-local
      RUN cd release && xs2 ci/ci-compile


      FROM debian as dist
      RUN apt-get update -y && apt-get upgrade -y
      RUN apt-get install -y sudo
      RUN echo "%sudo  ALL=(ALL) NOPASSWD: ALL" | tee -a /etc/sudoers
      RUN useradd -d /home/bob -m -G sudo bob
      USER bob
      WORKDIR /home/bob
      COPY --from=install /home/bob/release/bin/xs-compile /usr/bin
      COPY --from=install /home/bob/release/bin/xs-run /usr/bin
      COPY --from=install /home/bob/release/bin/xs2 /usr/bin
      COPY --from=install /home/bob/release/bin/xs-make-self-exec /usr/bin
      COPY --from=install /home/bob/release/bin/xs-write_file /usr/bin
  "#;

def docker = {
    let ctx = DOCKER_CONTEXT;
    !docker --context $ctx $args;
    0
}

def docker_build = {
    let Dockerfile = Dockerfile;
    let DOCKERFILE = DOCKERFILE;
    let ctx = DOCKER_CONTEXT;

    let tag = util/join "dust3:" $args;

    !xs-write_file $Dockerfile $DOCKERFILE;
    !docker
        --context $ctx
        buildx build
            --tag $tag
            --target $args
            -f $DOCKERFILE
            "."
}

def run_mount = {
    let VOLUME = VOLUME;
    let MEM = MEM;
    let BASE = BASE;
    let mount_spec = !printf "type=volume,source=%s,destination=%s" $VOLUME $MEM;

    docker run --mount $mount_spec $args
}
def run = {
    let BASE = BASE;
    run_mount --rm $BASE $args
}
def run_sh = run sh -x -e -c $args;

def vol = {
    let VOLUME = VOLUME;
    docker volume $args --force $VOLUME
}
def vol-ls = docker volume list;
def vol-del = vol rm;
def vol-new = vol create;

def diag = {
    run_sh "ls -la . && pwd && id -a && uname -a && date";
    0
}
def init = {
    run_sh "chown bob:bob $HOME";
    0
}
def touch = {
    run_sh "touch $1" - $args;
    0
}
def rm = {
    run_sh "rm $1" - $args;
    0
}
def rustup-dl = {
    run_sh "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs --output rustup.sh"
}
def rustup-init = {
    run_sh r#"bash rustup.sh -y --verbose "$@" "# - $args
}
def remove_cp_docker_container = {
    let COPY = COPY;
    docker rm --force $COPY;
    0
}
def ls =
    run_sh r#"ls "$@""# - $args
;
def cp = {
    let BASE = BASE;
    let COPY = COPY;

    remove_cp_docker_container;

    run_mount -d --name $COPY $BASE;

    !docker cp $args;

    0
}

def upload_release = {
    cp "_.release.tar" "d3c:/home/bob/_.release.tar";
    run_sh "mkdir -p src bin; tar -C src -x -v -f _.release.tar --atime-preserve";
    0
}

def download_release = {
    run_sh "tar -C src -cvf bin.tar bin";
    cp "d3c:/home/bob/bin.tar" "_.dist.deb.tar";
    0
}

def cargo = {
    let BASE = BASE;
    run_mount
        --workdir "/home/bob/src"
        --rm
        $BASE
        sh -x -e -c r#"
            . $HOME/.cargo/env &&
            cargo --color always "$@"
        "# - $args
}
def build = cargo build --all-targets;


def bootstrap = {
    let BASE = BASE;
    run_mount
        --workdir "/home/bob/src"
        --rm
        $BASE
        sh -x -e -c r#"
            . $HOME/.cargo/env &&
            target/debug/main ci/ci-install-local &&
            which xs2 &&
            which xs-compile &&
            which xs-run &&
            which xs-make-self-exec &&
            which xs-write_file &&
            xs2 ci/ci-compile &&
            bin/ci-tar &&
            echo help | bin/ci
        "# - $args
    ;
    0
}

def release = {
    upload_release;
    build;
    bootstrap;
    0
}

def del = {
    remove_cp_docker_container;
    vol-del;

    let BASE = BASE;
    let DIST = DIST;
    docker image rm --force $BASE $DIST;

    0
}

def new = {
    docker_build base;
    rustup-dl;
    rustup-init;
    0
}

def help = {
    !sed
        -r -n -e
        "s/^def +([^[:space:]]*).*/\1/p"
        ci/ci-test
    ;
    0
}

0
